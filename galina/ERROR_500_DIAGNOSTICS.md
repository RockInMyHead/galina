# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏ 500 (Internal Server Error)

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏ 500 –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ `/api/chat`

### 1. ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ —Å OPENAI_API_KEY** (–Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ)

**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ –ª—é–±—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ `/api/chat`
- –í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞: `OpenAI API error: 401` –∏–ª–∏ `403`

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ö–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ö–ª—é—á –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫
- –ö–ª—é—á –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥–µ–ª–∏ `gpt-5.1`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo $OPENAI_API_KEY

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –≤ api/.env
OPENAI_API_KEY=sk-proj-–≤–∞—à_—Ä–µ–∞–ª—å–Ω—ã–π_–∫–ª—é—á_–∑–¥–µ—Å—å

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä
pm2 restart api
# –∏–ª–∏
npm restart
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ curl
curl https://api.openai.com/v1/models \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  | grep -i "gpt-5.1\|gpt-4"
```

---

### 2. ‚ùå **–ú–æ–¥–µ–ª—å `gpt-5.1` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞**

**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö —Å –º–æ–¥–µ–ª—å—é `gpt-5.1`
- –í –ª–æ–≥–∞—Ö: `OpenAI API error: 404` –∏–ª–∏ `model_not_found`

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ú–æ–¥–µ–ª—å `gpt-5.1` –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å (–≤–æ–∑–º–æ–∂–Ω–æ, –∏–º–µ–ª–æ—Å—å –≤ –≤–∏–¥—É `gpt-4o` –∏–ª–∏ `gpt-4-turbo`)
- –£ –≤–∞—à–µ–≥–æ API –∫–ª—é—á–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏
- –ú–æ–¥–µ–ª—å –±—ã–ª–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
// –í api/index.js –∑–∞–º–µ–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—É—é:
model: 'gpt-4o' // –∏–ª–∏ 'gpt-4-turbo', 'gpt-4', 'gpt-3.5-turbo'
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π:**
```bash
curl https://api.openai.com/v1/models \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  | jq '.data[].id' | grep gpt
```

---

### 3. ‚ùå **–ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–æ–º**

**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ OpenAI API
- –í –ª–æ–≥–∞—Ö: `ECONNREFUSED`, `ETIMEDOUT`, –∏–ª–∏ –æ—à–∏–±–∫–∏ –ø—Ä–æ–∫—Å–∏

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–∫—Å–∏
- –ü—Ä–æ–∫—Å–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ OpenAI

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏ –≤ api/index.js –∏–ª–∏ .env
PROXY_HOST=185.68.187.20
PROXY_PORT=8000
PROXY_USERNAME=rBD9e6
PROXY_PASSWORD=jZdUnJ

# –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–æ–∫—Å–∏
curl -x http://rBD9e6:jZdUnJ@185.68.187.20:8000 https://api.openai.com/v1/models \
  -H "Authorization: Bearer $OPENAI_API_KEY"
```

**–í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ –¥–ª—è —Ç–µ—Å—Ç–∞:**
```javascript
// –í api/index.js –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–º–µ–Ω–∏—Ç–µ:
const fetchWithProxy = (url, options = {}) => {
  return fetch(url, options); // –ë–µ–∑ –ø—Ä–æ–∫—Å–∏
};
```

---

### 4. ‚ùå **–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ API**

**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∞ 500 –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
- –í –ª–æ–≥–∞—Ö: `rate_limit_exceeded`, `quota_exceeded`, –∏–ª–∏ `429`

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É (RPM)
- –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –≤ –º–∏–Ω—É—Ç—É (TPM)
- –ò—Å—á–µ—Ä–ø–∞–Ω –±–∞–ª–∞–Ω—Å –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ OpenAI

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ https://platform.openai.com/account/billing
- –£–≤–µ–ª–∏—á—å—Ç–µ –ª–∏–º–∏—Ç—ã –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –¥–µ—à–µ–≤—É—é –º–æ–¥–µ–ª—å

---

### 5. ‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞**

**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –í –ª–æ–≥–∞—Ö: `invalid_request_error` –∏–ª–∏ `400`

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –º–∞—Å—Å–∏–≤–∞ `messages`
- –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–†–µ—à–µ–Ω–∏–µ:**
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:
```json
{
  "messages": [
    {
      "role": "user",
      "content": "—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"
    }
  ],
  "model": "gpt-4o",
  "max_completion_tokens": 2000,
  "temperature": 0.7
}
```

---

### 6. ‚ùå **–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –∏–ª–∏ DNS**

**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –í –ª–æ–≥–∞—Ö: `ENOTFOUND`, `ECONNREFUSED`, `ETIMEDOUT`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å OpenAI API
curl -v https://api.openai.com/v1/models

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS
nslookup api.openai.com

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall
iptables -L -n | grep 443
```

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è PM2
pm2 logs api --lines 100

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è systemd
journalctl -u galina-api -n 100

# –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞–ø—Ä—è–º—É—é
tail -f /var/log/galina/api.log
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
cd /var/www/lawyer.windexs.ru/api
cat .env | grep OPENAI_API_KEY
```

### –®–∞–≥ 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ API –∫–ª—é—á –Ω–∞–ø—Ä—è–º—É—é
```bash
curl https://api.openai.com/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -d '{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "test"}],
    "max_tokens": 10
  }'
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ endpoint `/health`
```bash
curl https://lawyer.windexs.ru/api/health
```

–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
```json
{
  "status": "ok",
  "openai": "configured"  // –∏–ª–∏ "not configured"
}
```

---

## üõ†Ô∏è –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å –º–æ–¥–µ–ª—å—é:
1. –û—Ç–∫—Ä–æ–π—Ç–µ `api/index.js`
2. –ù–∞–π–¥–∏—Ç–µ –≤—Å–µ –≤—Ö–æ–∂–¥–µ–Ω–∏—è `'gpt-5.1'`
3. –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ `'gpt-4o'` –∏–ª–∏ –¥—Ä—É–≥—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –º–æ–¥–µ–ª—å
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

### –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å API –∫–ª—é—á–æ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª `api/.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `OPENAI_API_KEY` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

### –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ–∫—Å–∏:
1. –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç–µ –ø—Ä–æ–∫—Å–∏ –≤ `api/index.js`
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –±–µ–∑ –ø—Ä–æ–∫—Å–∏
3. –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–∫—Å–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## üìù –õ–æ–≥–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

–ü—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ:
1. –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫
2. –†–µ–∑—É–ª—å—Ç–∞—Ç `/api/health`
3. –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ API –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ curl
4. –í–µ—Ä—Å–∏—é Node.js: `node -v`
5. –í–µ—Ä—Å–∏—é npm: `npm -v`

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] `OPENAI_API_KEY` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `.env`
- [ ] API –∫–ª—é—á –≤–∞–ª–∏–¥–Ω—ã–π –∏ –∏–º–µ–µ—Ç –±–∞–ª–∞–Ω—Å
- [ ] –ú–æ–¥–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∫–ª—é—á–∞
- [ ] –ü—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- [ ] –ù–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ API
- [ ] –§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- [ ] –°–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ `api.openai.com`
- [ ] –ü–æ—Ä—Ç—ã 443 (HTTPS) –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
