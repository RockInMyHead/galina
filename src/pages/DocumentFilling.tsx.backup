import Header from "@/components/Header";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
import { FileEdit, FileText, CheckCircle2, ArrowRight, Scan, Camera, X, RotateCw, ZoomIn, Upload, MessageSquare, Download, RefreshCw } from "lucide-react";
import { Link, useNavigate } from "react-router-dom";
import { useState, useRef, useCallback, useEffect } from "react";
import { DOCUMENT_TEMPLATES } from "@/config/constants";

const DocumentFilling = () => {
  const navigate = useNavigate();
  const [isScanning, setIsScanning] = useState(false);
  const [showCamera, setShowCamera] = useState(false);
  const [capturedImage, setCapturedImage] = useState<string | null>(null);
  const [isProcessingImage, setIsProcessingImage] = useState(false);
  const [showTemplatePreview, setShowTemplatePreview] = useState(false);
  const [selectedTemplateForPreview, setSelectedTemplateForPreview] = useState<typeof DOCUMENT_TEMPLATES[0] | null>(null);
  const [isUploadingFile, setIsUploadingFile] = useState(false);
  const [uploadedFile, setUploadedFile] = useState<{
    name: string;
    data: string;
    type: string;
  } | null>(null);
  const [isAnalyzingDocument, setIsAnalyzingDocument] = useState(false);
  const [analysisResult, setAnalysisResult] = useState<string>('');

  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
  const [showInteractiveChat, setShowInteractiveChat] = useState(false);
  const [selectedTemplateForChat, setSelectedTemplateForChat] = useState<typeof DOCUMENT_TEMPLATES[0] | null>(null);
  const [chatMessages, setChatMessages] = useState<Array<{role: 'user' | 'assistant', content: string}>>([]);
  const [currentUserInput, setCurrentUserInput] = useState('');
  const [isWaitingForAI, setIsWaitingForAI] = useState(false);
  const [collectedData, setCollectedData] = useState<Record<string, string>>({});
  const [completedDocument, setCompletedDocument] = useState<string>('');
  const [isGeneratingDocument, setIsGeneratingDocument] = useState(false);

  const videoRef = useRef<HTMLVideoElement>(null);
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const streamRef = useRef<MediaStream | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const chatEndRef = useRef<HTMLDivElement>(null);

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω—ã –∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç
  const allTemplates = DOCUMENT_TEMPLATES;

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–∞ –ø–æ —à–∞–±–ª–æ–Ω—É
  const handleTemplateClick = (templateName: string) => {
    // –ù–∞—Ö–æ–¥–∏–º —à–∞–±–ª–æ–Ω –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è
    const template = allTemplates.find(t => t.name === templateName);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω –≤ localStorage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —á–∞—Ç–µ
    localStorage.setItem('selectedTemplate', templateName);
    localStorage.setItem('templateRequest', template?.requestText || `–ú–Ω–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å ${templateName.toLowerCase()}. ${template?.description || ''}`);

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —á–∞—Ç
    navigate('/chat');
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
  const handleInteractiveTemplateClick = (templateName: string) => {
    console.log('üöÄ handleInteractiveTemplateClick called with:', templateName);

    const template = allTemplates.find(t => t.name === templateName);
    if (!template) {
      console.error('‚ùå Template not found:', templateName);
      return;
    }

    console.log('‚úÖ Template found:', template.name);

    setSelectedTemplateForChat(template);
    setShowInteractiveChat(true);
    console.log('üì± Interactive chat modal should now be open');
    setChatMessages([]);
    setCollectedData({});
    setCompletedDocument('');
    setCurrentUserInput('');

    // –ù–∞—á–∏–Ω–∞–µ–º —á–∞—Ç —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    const welcomeMessage = {
      role: 'assistant' as const,
      content: `–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –≤–∞–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å ${template.name.toLowerCase()}.

–£ –º–µ–Ω—è –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –Ω–æ –º–Ω–µ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –µ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø–æ—Ä—è–¥–∫—É. –£–∫–∞–∂–∏—Ç–µ –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:

**–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ${template.name.toLowerCase()}:**

1. **–§–ò–û –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–Ω** (–ø–æ–ª–Ω–æ—Å—Ç—å—é, –∫–∞–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö)
2. **–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** (–∞–¥—Ä–µ—Å–∞, —Å—É–º–º—ã, —Å—Ä–æ–∫–∏, —É—Å–ª–æ–≤–∏—è)
3. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏** (–¥–∞—Ç—ã, –Ω–æ–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –æ—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è)

–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Å—Ä–∞–∑—É - —Ç–∞–∫ –±—É–¥–µ—Ç –±—ã—Å—Ç—Ä–µ–µ —Å–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç.`
    };

    setChatMessages([welcomeMessage]);
    console.log('üí¨ Welcome message with questions set');
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
  const sendFirstQuestion = async (template: typeof DOCUMENT_TEMPLATES[0]) => {
    console.log('üéØ sendFirstQuestion called for template:', template.name);
    setIsWaitingForAI(true);

    try {
      const systemPrompt = `–¢—ã - –ì–∞–ª–∏–Ω–∞, –æ–ø—ã—Ç–Ω—ã–π AI-—é—Ä–∏—Å—Ç. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞–ø–æ–ª–Ω–∏—Ç—å ${template.name}. 

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –ó–∞–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è —Å–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞
2. –°–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ 1-2 –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
4. –ö–æ–≥–¥–∞ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã, —Å–∫–∞–∑–∞—Ç—å "–ì–û–¢–û–í–û" –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç

–§–û–†–ú–ê–¢ –í–û–ü–†–û–°–û–í:
- –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã —á–µ—Ç–∫–æ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ
- –£–∫–∞–∑—ã–≤–∞–π –ø—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Å–∫–æ–±–∫–∞—Ö
- –ì—Ä—É–ø–ø–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å—ã –ª–æ–≥–∏—á–µ—Å–∫–∏

–¢–ò–ü –î–û–ö–£–ú–ï–ù–¢–ê: ${template.name}

–ü–ï–†–í–´–ô –®–ê–ì: –°–ø—Ä–æ—Å–∏ –æ —Å—Ç–æ—Ä–æ–Ω–∞—Ö –¥–æ–≥–æ–≤–æ—Ä–∞ (–§–ò–û, –ø–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∞–¥—Ä–µ—Å–∞)`;

      const response = await fetch('http://localhost:5001/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          messages: [
            {
              role: 'system',
              content: systemPrompt
            },
            {
              role: 'user',
              content: `–ù–∞—á–Ω–∏ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è ${template.name}`
            }
          ],
          model: 'gpt-4o',
          max_tokens: 500,
          temperature: 0.3,
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      const aiMessage = data.choices[0]?.message?.content || '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';

      console.log('‚úÖ First question response received:', aiMessage.substring(0, 100) + '...');
      setChatMessages(prev => [...prev, { role: 'assistant', content: aiMessage }]);
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:', error);
      setChatMessages(prev => [...prev, {
        role: 'assistant',
        content: '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å.'
      }]);
    } finally {
      console.log('üèÅ sendFirstQuestion finished');
      setIsWaitingForAI(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const handleSendMessage = async () => {
    if (!currentUserInput.trim() || !selectedTemplateForChat) return;

    const userMessage = { role: 'user' as const, content: currentUserInput };
    setChatMessages(prev => [...prev, userMessage]);
    setCurrentUserInput('');
    setIsWaitingForAI(true);

    try {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      setCollectedData(prev => ({
        ...prev,
        [Object.keys(prev).length.toString()]: currentUserInput
      }));

      const conversationHistory = [...chatMessages, userMessage];

      const systemPrompt = `–¢—ã - –ì–∞–ª–∏–Ω–∞, –æ–ø—ã—Ç–Ω—ã–π AI-—é—Ä–∏—Å—Ç. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞–ø–æ–ª–Ω–∏—Ç—å ${selectedTemplateForChat.name}.

–ó–ê–î–ê–ß–ê: –ó–∞–ø–æ–ª–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –ò–∑–≤–ª–µ–∫–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–æ—Ä–æ–Ω–∞—Ö –¥–æ–≥–æ–≤–æ—Ä–∞
2. –ó–∞–ø–æ–ª–Ω–∏ –í–°–ï –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
3. –î–æ–±–∞–≤—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –¥–ª—è [–î–ê–¢–ê] –∏ [–ú–ï–°–Ø–¶] [–ì–û–î]
4. –î–ª—è –≥–æ—Ä–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π "–≥. –ú–æ—Å–∫–≤–∞" –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ
5. –ï—Å–ª–∏ –∫–∞–∫–∏—Ö-—Ç–æ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π –ª–æ–≥–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ì–û–¢–û–í–û
[–ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –±–µ–∑ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤]

–®–ê–ë–õ–û–ù –î–û–ö–£–ú–ï–ù–¢–ê:
${selectedTemplateForChat.template}`;

      const response = await fetch('http://localhost:5001/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          messages: [
            {
              role: 'system',
              content: systemPrompt
            },
            ...conversationHistory.map(msg => ({
              role: msg.role,
              content: msg.content
            }))
          ],
          model: 'gpt-4o',
          max_tokens: 2000,
          temperature: 0.3,
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      const aiMessage = data.choices[0]?.message?.content || '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.';

      setChatMessages(prev => [...prev, { role: 'assistant', content: aiMessage }]);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ—Ç–≤–µ—Ç "–ì–û–¢–û–í–û" - –∑–Ω–∞—á–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤
      if (aiMessage.toUpperCase().includes('–ì–û–¢–û–í–û') || aiMessage.includes('–¥–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤')) {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ –æ—Ç–≤–µ—Ç–∞
        const documentMatch = aiMessage.match(/–ì–û–¢–û–í–û[\s\S]*?([\s\S]+)/) ||
                             aiMessage.match(/–¥–æ–∫—É–º–µ–Ω—Ç[\s\S]*?([\s\S]+)/) ||
                             aiMessage;

        if (documentMatch) {
          const finalDocument = typeof documentMatch === 'string' ? documentMatch :
                               documentMatch[1] || aiMessage;
          setCompletedDocument(finalDocument);
        }
      }

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
      setChatMessages(prev => [...prev, {
        role: 'assistant',
        content: '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—â–µ —Ä–∞–∑.'
      }]);
    } finally {
      setIsWaitingForAI(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
  const downloadDocument = () => {
    if (!completedDocument || !selectedTemplateForChat) return;

    const blob = new Blob([completedDocument], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${selectedTemplateForChat.name}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —á–∞—Ç–∞
  const resetChat = () => {
    setShowInteractiveChat(false);
    setSelectedTemplateForChat(null);
    setChatMessages([]);
    setCollectedData({});
    setCompletedDocument('');
    setCurrentUserInput('');
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —à–∞–±–ª–æ–Ω–∞
  const handleTemplatePreview = (templateName: string) => {
    const template = allTemplates.find(t => t.name === templateName);
    if (template) {
      setSelectedTemplateForPreview(template);
      setShowTemplatePreview(true);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞–º–µ—Ä—ã
  const handleScanDocument = () => {
    setShowCamera(true);
    startCamera();
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
  const handleUploadDocument = () => {
    fileInputRef.current?.click();
  };

  // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 15MB –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Vision API)
    if (file.size > 15 * 1024 * 1024) {
      alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 15MB –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
    const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
    if (!allowedTypes.includes(file.type)) {
      alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω—ã: JPEG, PNG, PDF');
      return;
    }

    setIsUploadingFile(true);

    try {
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ base64
      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result as string;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
        setUploadedFile({
          name: file.name,
          data: base64,
          type: file.type
        });

        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
        setAnalysisResult('');
      };
      reader.readAsDataURL(file);

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:', error);
      alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
    } finally {
      setIsUploadingFile(false);
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
  const analyzeDocumentType = (fileName: string) => {
    const name = fileName.toLowerCase();

    // –ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
    if (name.includes('–¥–æ–≥–æ–≤–æ—Ä') || name.includes('–¥–æ–≥') || name.includes('contract')) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Ç–∏–ø—ã –¥–æ–≥–æ–≤–æ—Ä–æ–≤
      if (name.includes('–∫—É–ø–ª–∏') || name.includes('–ø—Ä–æ–¥–∞–∂') || name.includes('sale')) return '–î–æ–≥–æ–≤–æ—Ä –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏';
      if (name.includes('–∞—Ä–µ–Ω–¥') || name.includes('rent')) return '–î–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã –∂–∏–ª–æ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è';
      if (name.includes('—É—Å–ª—É–≥') || name.includes('service')) return '–î–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥';
      if (name.includes('–ø–æ–¥—Ä—è–¥') || name.includes('contractor')) return '–î–æ–≥–æ–≤–æ—Ä –ø–æ–¥—Ä—è–¥–∞';
      if (name.includes('—Ç—Ä—É–¥') || name.includes('labor') || name.includes('—Ä–∞–±–æ—Ç')) return '–¢—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä';
      if (name.includes('–ø–æ—Å—Ç–∞–≤–∫') || name.includes('supply')) return '–î–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏';
      if (name.includes('–∑–∞–π–º') || name.includes('loan')) return '–î–æ–≥–æ–≤–æ—Ä –∑–∞–π–º–∞';
      if (name.includes('–¥–∞—Ä–µ–Ω–∏') || name.includes('gift')) return '–î–æ–≥–æ–≤–æ—Ä –¥–∞—Ä–µ–Ω–∏—è';

      // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –Ω–∞–∏–±–æ–ª–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–∏–ø
      if (/\d+/.test(name) || name.includes('(') || name.includes(')')) {
        return '–î–æ–≥–æ–≤–æ—Ä –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏'; // –°–∞–º—ã–π —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–∏–ø
      }

      return '–î–æ–≥–æ–≤–æ—Ä (–Ω—É–∂–µ–Ω –∞–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è)';
    }

    // –ê–Ω–∞–ª–∏–∑ –ø–∞—Å–ø–æ—Ä—Ç–æ–≤ –∏ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–π
    if (name.includes('–ø–∞—Å–ø–æ—Ä—Ç') || name.includes('passport')) return '–ü–∞—Å–ø–æ—Ä—Ç –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞ –†–§';
    if (name.includes('—Å–Ω–∏–ª—Å') || name.includes('snils')) return '–°–ù–ò–õ–° (–°—Ç—Ä–∞—Ö–æ–≤–æ–µ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ)';
    if (name.includes('–ø—Ä–∞–≤–∞') || name.includes('–≤/—É') || name.includes('driver')) return '–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ';
    if (name.includes('–∑–∞–≥—Ä–∞–Ω') || name.includes('foreign')) return '–ó–∞–≥—Ä–∞–Ω–∏—á–Ω—ã–π –ø–∞—Å–ø–æ—Ä—Ç';

    // –ê–Ω–∞–ª–∏–∑ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤
    if (name.includes('—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤') || name.includes('certificate')) {
      if (name.includes('—Ä–æ–∂–¥–µ–Ω–∏') || name.includes('birth')) return '–°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ —Ä–æ–∂–¥–µ–Ω–∏–∏';
      if (name.includes('–±—Ä–∞–∫') || name.includes('marriage') || name.includes('–∑–∞–∫–ª—é—á–µ–Ω–∏')) return '–°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –±—Ä–∞–∫–∞';
      if (name.includes('—Ä–∞–∑–≤–æ–¥') || name.includes('—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω') || name.includes('divorce')) return '–°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –±—Ä–∞–∫–∞';
      if (name.includes('—Å–º–µ—Ä—Ç') || name.includes('death')) return '–°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ —Å–º–µ—Ä—Ç–∏';
      if (name.includes('—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç') || name.includes('ownership')) return '–°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∞–≤–∞';
      return '–°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ';
    }

    // –ê–Ω–∞–ª–∏–∑ —Å–ø—Ä–∞–≤–æ–∫
    if (name.includes('—Å–ø—Ä–∞–≤–∫') || name.includes('reference') || name.includes('–≤—ã–ø–∏—Å–∫')) {
      if (name.includes('–¥–æ—Ö–æ–¥') || name.includes('income') || name.includes('2-–Ω–¥—Ñ–ª')) return '–°–ø—Ä–∞–≤–∫–∞ –æ –¥–æ—Ö–æ–¥–∞—Ö (2-–ù–î–§–õ)';
      if (name.includes('—Å–µ–º—å') || name.includes('family') || name.includes('—Å–æ—Å—Ç–∞–≤')) return '–°–ø—Ä–∞–≤–∫–∞ –æ —Å–æ—Å—Ç–∞–≤–µ —Å–µ–º—å–∏';
      if (name.includes('–º–µ—Å—Ç') || name.includes('address') || name.includes('—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü')) return '–°–ø—Ä–∞–≤–∫–∞ –æ –º–µ—Å—Ç–µ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)';
      if (name.includes('–Ω–µ—Å—É–¥–∏–º–æ—Å—Ç') || name.includes('criminal')) return '–°–ø—Ä–∞–≤–∫–∞ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏';
      if (name.includes('–ø–µ–Ω—Å–∏') || name.includes('pension')) return '–°–ø—Ä–∞–≤–∫–∞ –æ —Ä–∞–∑–º–µ—Ä–µ –ø–µ–Ω—Å–∏–∏';
      return '–°–ø—Ä–∞–≤–∫–∞ (–≤—ã–ø–∏—Å–∫–∞)';
    }

    // –ê–Ω–∞–ª–∏–∑ –¥—Ä—É–≥–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    if (name.includes('–∞–∫—Ç') || name.includes('act')) return '–ê–∫—Ç (–ø—Ä–∏–µ–º–∫–∏-–ø–µ—Ä–µ–¥–∞—á–∏, —Å–≤–µ—Ä–∫–∏ –∏ —Ç.–¥.)';
    if (name.includes('–∏—Å–∫') || name.includes('–∑–∞—è–≤–ª–µ–Ω') || name.includes('claim')) return '–ò—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ';
    if (name.includes('–¥–æ–≤–µ—Ä–µ–Ω') || name.includes('power') || name.includes('–¥–æ–≤–µ—Ä–∏—Ç–µ–ª')) return '–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å';
    if (name.includes('–ø—Ä–µ—Ç–µ–Ω–∑') || name.includes('–∂–∞–ª–æ–±') || name.includes('complaint')) return '–ü—Ä–µ—Ç–µ–Ω–∑–∏—è (–ø—Ä–µ—Ç–µ–Ω–∑–∏–æ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ)';
    if (name.includes('—Å—á–µ—Ç') || name.includes('invoice')) return '–°—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É';
    if (name.includes('—á–µ–∫') || name.includes('check') || name.includes('–∫–≤–∏—Ç–∞–Ω—Ü')) return '–ß–µ–∫ (–∫–≤–∏—Ç–∞–Ω—Ü–∏—è)';

    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ, –Ω–æ –µ—Å—Ç—å —Ü–∏—Ñ—Ä—ã –∏–ª–∏ —Å–∫–æ–±–∫–∏ - –≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–≥–æ–≤–æ—Ä
    if (/\d+/.test(name) || name.includes('(') || name.includes(')')) {
      return '–î–æ–≥–æ–≤–æ—Ä (–Ω—É–∂–µ–Ω –∞–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è)';
    }

    return '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç';
  };

  // –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
  const handleAnalyzeDocument = async () => {
    if (!uploadedFile) return;

    setIsAnalyzingDocument(true);

    try {
      console.log('üìÑ –ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', uploadedFile.name);

      // –°–Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ Vision API
      let documentAnalysis = '';

      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        const fileSizeMB = uploadedFile.data.length / (1024 * 1024);
        console.log('üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:', fileSizeMB.toFixed(2), 'MB');

        if (fileSizeMB > 15) {
          console.log('‚ö†Ô∏è –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–∞–ª–∏–∑ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é');
          throw new Error('FILE_TOO_LARGE');
        }

        console.log('üîç –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ Vision API');

        const response = await fetch('http://localhost:5001/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            messages: [
              {
                role: 'system',
                content: `–¢—ã - –ì–∞–ª–∏–Ω–∞, –æ–ø—ã—Ç–Ω—ã–π AI-—é—Ä–∏—Å—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∏ –∏–∑–≤–ª–µ—á—å –∏–∑ –Ω–µ–≥–æ –≤—Å—é –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–¥–æ–≥–æ–≤–æ—Ä, —Å–ø—Ä–∞–≤–∫–∞, –∑–∞—è–≤–ª–µ–Ω–∏–µ –∏ —Ç.–¥.)
2. –ò–∑–≤–ª–µ–∫–∏ –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –§–ò–û, –∞–¥—Ä–µ—Å–∞, —Å—É–º–º—ã, –¥–∞—Ç—ã, –Ω–æ–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
3. –û–ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞
4. –£–∫–∞–∂–∏, –∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ù–ï –•–í–ê–¢–ê–ï–¢ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
## –ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
**–¢–∏–ø:** [—Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞]
**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- [—Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö]
**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
- [—Å–ø–∏—Å–æ–∫ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö]

–ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–º –∏ —Ç–æ—á–Ω—ã–º!`
        },
        {
          role: 'user',
          content: [
            {
              type: 'text',
                    text: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç: ${uploadedFile.name}`
            },
            {
              type: 'image_url',
              image_url: {
                url: uploadedFile.data.startsWith('data:')
                  ? uploadedFile.data
                  : `data:image/jpeg;base64,${uploadedFile.data}`
              }
            }
          ]
        }
            ],
            model: 'gpt-4o',
            max_tokens: 1000,
            temperature: 0.3,
          })
        });

        if (response.ok) {
          const data = await response.json();
          documentAnalysis = data.choices[0]?.message?.content || '';
          console.log('‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Vision API');
        } else {
          console.log('‚ö†Ô∏è Vision API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∞–Ω–∞–ª–∏–∑—É –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é');
          throw new Error('VISION_API_FAILED');
        }

      } catch (visionError) {
        console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–∞–ª–∏–∑ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–π–ª–∞');
        documentAnalysis = `## –ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
**–¢–∏–ø:** ${analyzeDocumentType(uploadedFile.name)}
**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** –î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:** –í—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è`;
      }

      console.log('üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:', documentAnalysis.substring(0, 200) + '...');

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞
      let documentType = analyzeDocumentType(uploadedFile.name);

      // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å —Ç–∏–ø –∏–∑ –∞–Ω–∞–ª–∏–∑–∞
      const typeMatch = documentAnalysis.match(/\*\*–¢–∏–ø:\*\*\s*([^\n]+)/);
      if (typeMatch) {
        documentType = typeMatch[1].trim();
        console.log('üéØ –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏–∑ –∞–Ω–∞–ª–∏–∑–∞:', documentType);
      }

      // –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
      let selectedTemplate = null;

      if (documentType.includes('–∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏')) {
        selectedTemplate = allTemplates.find(t => t.name.includes('–∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏'));
      } else if (documentType.includes('–∞—Ä–µ–Ω–¥—ã') || documentType.includes('–∞—Ä–µ–Ω–¥')) {
        selectedTemplate = allTemplates.find(t => t.name.includes('–∞—Ä–µ–Ω–¥—ã'));
      } else if (documentType.includes('—Ç—Ä—É–¥–æ–≤') || documentType.includes('—Ä–∞–±–æ—Ç')) {
        selectedTemplate = allTemplates.find(t => t.name.includes('—Ç—Ä—É–¥–æ–≤–æ–π'));
      } else if (documentType.includes('–∏—Å–∫–æ–≤') || documentType.includes('–∑–∞—è–≤–ª–µ–Ω')) {
        selectedTemplate = allTemplates.find(t => t.name.includes('–∏—Å–∫–æ–≤–æ–µ'));
      } else if (documentType.includes('–¥–æ–≤–µ—Ä–µ–Ω')) {
        selectedTemplate = allTemplates.find(t => t.name.includes('–¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å'));
      } else if (documentType.includes('–ø—Ä–µ—Ç–µ–Ω–∑')) {
        selectedTemplate = allTemplates.find(t => t.name.includes('–ø—Ä–µ—Ç–µ–Ω–∑–∏—è'));
      }

      if (selectedTemplate) {
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω:', selectedTemplate.name);

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        setSelectedTemplateForChat(selectedTemplate);
        setShowInteractiveChat(true);
        setChatMessages([]);
        setCollectedData({});
        setCompletedDocument('');
        setCurrentUserInput('');

        // –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞
        const welcomeMessage = {
          role: 'assistant' as const,
          content: `–ü—Ä–∏–≤–µ—Ç! –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞ –≤–∞—à –¥–æ–∫—É–º–µ–Ω—Ç "${uploadedFile.name}".

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:**
${documentAnalysis}

–¢–µ–ø–µ—Ä—å —è –ø–æ–º–æ–≥—É –≤–∞–º —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —ç—Ç–æ–≥–æ —Ç–∏–ø–∞. –£ –º–µ–Ω—è –µ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —à–∞–±–ª–æ–Ω–∞, –Ω–æ –º–Ω–µ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –µ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø–æ—Ä—è–¥–∫—É. –£–∫–∞–∂–∏—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ/–∏—Å–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ:

**–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ${selectedTemplate.name.toLowerCase()}:**

1. **–§–ò–û –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–Ω** (–ø–æ–ª–Ω–æ—Å—Ç—å—é, –∫–∞–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö)
2. **–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** (–∞–¥—Ä–µ—Å–∞, —Å—É–º–º—ã, —Å—Ä–æ–∫–∏, —É—Å–ª–æ–≤–∏—è)
3. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏** (–¥–∞—Ç—ã, –Ω–æ–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –æ—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è)

–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Å—Ä–∞–∑—É - —Ç–∞–∫ –±—É–¥–µ—Ç –±—ã—Å—Ç—Ä–µ–µ —Å–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç.`
        };

        setChatMessages([welcomeMessage]);
        console.log('üí¨ –ß–∞—Ç –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞');

        } else {
        // –ï—Å–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑
        console.log('‚ùå –ü–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —Ç–∏–ø–∞:', documentType);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤–º–µ—Å—Ç–æ —á–∞—Ç–∞
        setAnalysisResult(documentAnalysis);
        alert(`–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç –∏ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞ —Ç–∏–ø: "${documentType}". –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∫–∞–∑–∞–Ω—ã –Ω–∏–∂–µ. –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –ø–æ–∫–∞ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞.`);
      }

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', error);
      alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    } finally {
      setIsAnalyzingDocument(false);
    }
  };

  // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
  const startCamera = useCallback(async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment', // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      });

      streamRef.current = stream;

      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        videoRef.current.play();
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
      setShowCamera(false);
    }
  }, []);

  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
  const stopCamera = useCallback(() => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
    if (videoRef.current) {
      videoRef.current.srcObject = null;
    }
  }, []);

  // –°—ä–µ–º–∫–∞ —Ñ–æ—Ç–æ
  const capturePhoto = useCallback(() => {
    if (videoRef.current && canvasRef.current) {
      const canvas = canvasRef.current;
      const video = videoRef.current;

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const ctx = canvas.getContext('2d');
      if (ctx) {
        ctx.drawImage(video, 0, 0);

        // –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ base64
        const imageData = canvas.toDataURL('image/jpeg', 0.9);
        setCapturedImage(imageData);

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
        stopCamera();
      }
    }
  }, [stopCamera]);

  // –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const processImage = useCallback(async (imageData: string) => {
    setIsProcessingImage(true);

    try {
      // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
      const img = new Image();
      await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = reject;
        img.src = imageData;
      });

      // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      if (!ctx) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å canvas context');
      }

      canvas.width = img.width;
      canvas.height = img.height;

      // –†–∏—Å—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      ctx.drawImage(img, 0, 0);

      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const imageDataObj = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageDataObj.data;

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –±–∞–∑–æ–≤—É—é –ø–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫—É:
      // 1. –£–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
      // 2. –ü–æ–≤—ã—à–µ–Ω–∏–µ —Ä–µ–∑–∫–æ—Å—Ç–∏
      // 3. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è —è—Ä–∫–æ—Å—Ç–∏

      for (let i = 0; i < data.length; i += 4) {
        // –£–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 1.2)
        const contrast = 1.2;
        data[i] = ((data[i] / 255 - 0.5) * contrast + 0.5) * 255;     // R
        data[i + 1] = ((data[i + 1] / 255 - 0.5) * contrast + 0.5) * 255; // G
        data[i + 2] = ((data[i + 2] / 255 - 0.5) * contrast + 0.5) * 255; // B

        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
        data[i] = Math.max(0, Math.min(255, data[i]));
        data[i + 1] = Math.max(0, Math.min(255, data[i + 1]));
        data[i + 2] = Math.max(0, Math.min(255, data[i + 2]));
      }

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      ctx.putImageData(imageDataObj, 0, 0);

      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      const processedImageData = canvas.toDataURL('image/jpeg', 0.95);
      console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ');

      return processedImageData;

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∏:', error);
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
      return imageData;
    } finally {
      setIsProcessingImage(false);
    }
  }, []);

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ —á–∞—Ç
  const sendToChat = useCallback(async () => {
    if (!capturedImage) return;

    setIsScanning(true);

    try {
      const processedImage = await processImage(capturedImage);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ localStorage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —á–∞—Ç–µ
      localStorage.setItem('scannedDocument', processedImage);
      localStorage.setItem('scanRequest', '–Ø –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç —Å –∫–∞–º–µ—Ä—ã. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ –∏ –ø–æ–º–æ–≥–∏ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω.');

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      setShowCamera(false);
      setCapturedImage(null);

      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —á–∞—Ç
      navigate('/chat');

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', error);
      alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
    } finally {
      setIsScanning(false);
    }
  }, [capturedImage, processImage, navigate]);

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  const closeCamera = useCallback(() => {
    stopCamera();
    setShowCamera(false);
    setCapturedImage(null);
  }, [stopCamera]);

  // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
  useEffect(() => {
    return () => {
      stopCamera();
  };
  }, [stopCamera]);

  // –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —á–∞—Ç–∞ –≤–Ω–∏–∑ –ø—Ä–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
  useEffect(() => {
    if (chatEndRef.current) {
      chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [chatMessages]);

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-muted/20">
      <Header />
      
      <main className="flex-1">
        <div className="container mx-auto px-4 py-12">
          {/* Header Section */}
          <div className="mb-12 text-center space-y-4">
            <div className="flex justify-center mb-4">
              <div className="flex h-16 w-16 items-center justify-center rounded-full bg-primary/10 text-primary">
                <FileEdit className="h-8 w-8" />
              </div>
            </div>
            <h1 className="text-4xl md:text-5xl font-bold text-foreground">
              –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            </h1>
            <p className="text-lg text-muted-foreground max-w-2xl mx-auto">
              –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ —Å –ø–æ–º–æ—â—å—é –ì–∞–ª–∏–Ω—ã. AI –ø–æ–º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –ø–æ–ª—è –∏ —É—á—Ç–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞.
            </p>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-7xl mx-auto">
            {/* Templates Section */}
            <div className="lg:col-span-2 space-y-6">
              <div>
                <h2 className="text-2xl font-bold text-foreground mb-6">
                  –î–æ—Å—Ç—É–ø–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
                </h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {allTemplates.map((template, index) => (
                    <Card
                      key={index}
                      className="border-border/50 hover:shadow-elegant transition-smooth group cursor-pointer"
                      onClick={() => handleTemplateClick(template.name)}
                    >
                      <CardContent className="p-6">
                        <div className="flex items-start justify-between gap-4">
                          <div className="flex-1 space-y-2">
                            <div className="flex items-center gap-2">
                              <FileText className="h-5 w-5 text-primary" />
                              <h3 className="font-semibold text-foreground group-hover:text-primary transition-smooth">
                                {template.name}
                              </h3>
                            </div>
                            <p className="text-sm text-muted-foreground">
                              {template.description}
                            </p>
                          </div>
                          <div className="flex items-center gap-2 flex-shrink-0">
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={(e) => {
                                e.stopPropagation();
                                handleTemplatePreview(template.name);
                              }}
                              className="h-8 px-2 text-xs"
                            >
                              –ü—Ä–æ—Å–º–æ—Ç—Ä
                            </Button>
                            <Button
                              size="sm"
                              onClick={(e) => {
                                console.log('üîò Fill button clicked for:', template.name);
                                e.stopPropagation();
                                handleInteractiveTemplateClick(template.name);
                              }}
                              className="h-8 px-2 text-xs flex items-center gap-1 bg-primary text-primary-foreground hover:bg-primary/90"
                            >
                              <MessageSquare className="h-3 w-3" />
                              –ó–∞–ø–æ–ª–Ω–∏—Ç—å
                            </Button>
                            <ArrowRight className="h-5 w-5 text-muted-foreground group-hover:text-primary transition-smooth" />
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  ))}
                </div>

                {/* –ö–Ω–æ–ø–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ */}
                <div className="mt-6 space-y-4">
                  {/* –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */}
                  <Card className="border-border/50 hover:shadow-elegant transition-smooth group cursor-pointer" onClick={handleScanDocument}>
                    <CardContent className="p-6">
                      <div className="flex items-center gap-4">
                        <div className="flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary">
                          <Scan className="h-6 w-6" />
                        </div>
                        <div className="flex-1">
                          <h3 className="font-semibold text-foreground group-hover:text-primary transition-smooth">
                            –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
                          </h3>
                          <p className="text-sm text-muted-foreground">
                            {isScanning ? "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ..." : "–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –∫–∞–º–µ—Ä–æ–π"}
                          </p>
                        </div>
                        <ArrowRight className="h-5 w-5 text-muted-foreground group-hover:text-primary transition-smooth flex-shrink-0" />
                      </div>
                    </CardContent>
                  </Card>

                  {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */}
                  <Card className={`border-border/50 hover:shadow-elegant transition-smooth group cursor-pointer ${
                    uploadedFile ? 'border-green-200 bg-green-50/50' : ''
                  }`} onClick={handleUploadDocument}>
                    <CardContent className="p-6">
                      <div className="flex items-center gap-4">
                        <div className={`flex h-12 w-12 items-center justify-center rounded-full ${
                          uploadedFile ? 'bg-green-500/20 text-green-700' : 'bg-green-500/10 text-green-600'
                        }`}>
                          <Upload className="h-6 w-6" />
                        </div>
                        <div className="flex-1">
                          <h3 className="font-semibold text-foreground group-hover:text-primary transition-smooth">
                            {uploadedFile ? '–ó–∞–º–µ–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç' : 'üìÑ –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ'}
                          </h3>
                          <p className="text-sm text-muted-foreground">
                            {isUploadingFile ? "–ó–∞–≥—Ä—É–∑–∫–∞..." :
                             uploadedFile ?
                             `–ó–∞–≥—Ä—É–∂–µ–Ω: ${uploadedFile.name}` :
                             "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç, –∏ —è –æ—Ç–∫—Ä–æ—é —á–∞—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞"}
                          </p>
                        </div>
                        <ArrowRight className="h-5 w-5 text-muted-foreground group-hover:text-primary transition-smooth flex-shrink-0" />
                      </div>
                    </CardContent>
                  </Card>

                  {/* –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ */}
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept=".jpg,.jpeg,.png,.pdf"
                    onChange={handleFileSelect}
                    className="hidden"
                  />
                </div>

                {/* –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ */}
                {uploadedFile && (
                  <div className="mt-8">
                    <Card className="border-border/50">
                      <CardContent className="p-6">
                        <div className="space-y-4">
                          <div className="flex items-center justify-between">
                            <h3 className="text-lg font-semibold text-foreground">
                              –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
                            </h3>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => setUploadedFile(null)}
                            >
                              –£–¥–∞–ª–∏—Ç—å
                            </Button>
                          </div>

                          {/* –ü—Ä–µ–≤—å—é —Ñ–∞–π–ª–∞ */}
                          <div className="flex items-center gap-4 p-4 bg-muted/50 rounded-lg">
                            {uploadedFile.type.startsWith('image/') ? (
                              <div className="flex items-center gap-3">
                                <div className="w-16 h-16 bg-white rounded border overflow-hidden flex items-center justify-center">
                                  <img
                                    src={uploadedFile.data}
                                    alt={uploadedFile.name}
                                    className="max-w-full max-h-full object-contain"
                                  />
                                </div>
                                <div>
                                  <p className="font-medium">{uploadedFile.name}</p>
                                  <p className="text-sm text-muted-foreground">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                                </div>
                              </div>
                            ) : (
                              <div className="flex items-center gap-3">
                                <div className="w-16 h-16 bg-white rounded border flex items-center justify-center">
                                  <FileText className="h-8 w-8 text-muted-foreground" />
                                </div>
                                <div>
                                  <p className="font-medium">{uploadedFile.name}</p>
                                  <p className="text-sm text-muted-foreground">PDF –¥–æ–∫—É–º–µ–Ω—Ç</p>
                                </div>
                              </div>
                            )}
                          </div>

                          {/* –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ */}
                            <Button
                              onClick={handleAnalyzeDocument}
                              disabled={isAnalyzingDocument}
                              className="w-full"
                            >
                              {isAnalyzingDocument ? (
                                <>
                                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                                –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–æ–∫—É–º–µ–Ω—Ç...
                                </>
                              ) : (
                              <>
                                <MessageSquare className="h-4 w-4 mr-2" />
                                –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                              </>
                              )}
                            </Button>
                        </div>
                      </CardContent>
                    </Card>
                  </div>
                )}
              </div>

              <Card className="border-border/50 bg-primary/5">
                <CardContent className="p-6">
                  <h3 className="text-lg font-semibold text-foreground mb-4">
                    –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?
                  </h3>
                  <div className="space-y-4">
                    <div>
                      <h4 className="font-medium text-foreground mb-2">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ:</h4>
                      <ol className="space-y-2">
                        {[
                          "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ó–∞–ø–æ–ª–Ω–∏—Ç—å' –Ω–∞ —à–∞–±–ª–æ–Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞",
                          "–ì–∞–ª–∏–Ω–∞ –∑–∞–¥–∞—Å—Ç –≤–æ–ø—Ä–æ—Å—ã –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö",
                          "–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã",
                          "AI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –ø–æ–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞",
                          "–°–∫–∞—á–∞–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç",
                    ].map((step, index) => (
                      <li key={index} className="flex items-start gap-3 text-sm">
                            <div className="flex h-5 w-5 items-center justify-center rounded-full bg-primary text-primary-foreground flex-shrink-0 text-xs font-semibold">
                          {index + 1}
                        </div>
                        <span className="text-muted-foreground mt-0.5">{step}</span>
                      </li>
                    ))}
                  </ol>
                    </div>

                    <div>
                      <h4 className="font-medium text-foreground mb-2">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞:</h4>
                      <ol className="space-y-2">
                        {[
                          "–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –ª—é–±–æ–≥–æ —Ç–∏–ø–∞",
                          "AI –æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –æ—Ç–∫—Ä–æ–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç",
                          "–ì–∞–ª–∏–Ω–∞ –∑–∞–¥–∞—Å—Ç –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö",
                          "–ü–æ–ª—É—á–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç",
                        ].map((step, index) => (
                          <li key={index} className="flex items-start gap-3 text-sm">
                            <div className="flex h-5 w-5 items-center justify-center rounded-full bg-blue-500 text-white flex-shrink-0 text-xs font-semibold">
                              {index + 1}
                            </div>
                            <span className="text-muted-foreground mt-0.5">{step}</span>
                          </li>
                        ))}
                      </ol>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Info Section */}
            <div className="space-y-6">
              <Card className="gradient-card border-border/50 shadow-elegant">
                <CardContent className="p-6">
                  <h3 className="text-lg font-semibold text-foreground mb-4">
                    –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
                  </h3>
                  <ul className="space-y-3">
                    {[
                      "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É",
                      "–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ",
                      "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ",
                      "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏",
                      "–ì–æ—Ç–æ–≤—ã–µ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –¥–æ–∫—É–º–µ–Ω—Ç—ã",
                    ].map((item, index) => (
                      <li key={index} className="flex items-start gap-2 text-sm">
                        <CheckCircle2 className="h-5 w-5 text-primary flex-shrink-0 mt-0.5" />
                        <span className="text-muted-foreground">{item}</span>
                      </li>
                    ))}
                  </ul>
                </CardContent>
              </Card>

              <Card className="border-border/50">
                <CardContent className="p-6">
                  <h3 className="text-lg font-semibold text-foreground mb-4">
                    –ù—É–∂–µ–Ω –¥—Ä—É–≥–æ–π –¥–æ–∫—É–º–µ–Ω—Ç?
                  </h3>
                  <p className="text-sm text-muted-foreground mb-4">
                    –ù–µ –Ω–∞—à–ª–∏ –Ω—É–∂–Ω—ã–π —à–∞–±–ª–æ–Ω? –û–ø–∏—à–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –≤ —á–∞—Ç–µ, –∏ –ì–∞–ª–∏–Ω–∞ –ø–æ–º–æ–∂–µ—Ç –µ–≥–æ —Å–æ–∑–¥–∞—Ç—å.
                  </p>
                  <Button variant="outline" className="w-full" asChild>
                    <Link to="/chat">
                      –ü–µ—Ä–µ–π—Ç–∏ –≤ —á–∞—Ç
                    </Link>
                  </Button>
                </CardContent>
              </Card>
          </div>
        </div>
      </main>

      {/* Camera Modal */}
      <Dialog open={showCamera} onOpenChange={closeCamera}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-hidden">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <Camera className="h-5 w-5" />
              –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            </DialogTitle>
            <DialogDescription>
              –ü–æ–º–µ—Å—Ç–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ä–∞–º–∫—É –∏ —Å–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4">
            {!capturedImage ? (
              // Camera view
              <div className="space-y-4">
                <div className="relative bg-black rounded-lg overflow-hidden">
                  <video
                    ref={videoRef}
                    autoPlay
                    playsInline
                    muted
                    className="w-full h-auto max-h-96 object-cover"
                  />
                  <canvas ref={canvasRef} className="hidden" />

                  {/* Camera overlay with document guide */}
                  <div className="absolute inset-4 border-2 border-dashed border-white/50 rounded-lg pointer-events-none">
                    <div className="absolute inset-0 flex items-center justify-center">
                      <div className="text-white/70 text-center">
                        <Scan className="h-8 w-8 mx-auto mb-2" />
                        <p className="text-sm">–ü–æ–º–µ—Å—Ç–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ä–∞–º–∫—É</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="flex gap-2 justify-center">
                  <Button
                    onClick={capturePhoto}
                    size="lg"
                    className="flex items-center gap-2"
                  >
                    <Camera className="h-5 w-5" />
                    –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å
                  </Button>
                  <Button
                    onClick={closeCamera}
                    variant="outline"
                    size="lg"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </Button>
                </div>
              </div>
            ) : (
              // Captured image view
              <div className="space-y-4">
                <div className="relative bg-muted rounded-lg overflow-hidden">
                  <img
                    src={capturedImage}
                    alt="–°–Ω—è—Ç—ã–π –¥–æ–∫—É–º–µ–Ω—Ç"
                    className="w-full h-auto max-h-96 object-contain"
                  />

                  {isProcessingImage && (
                    <div className="absolute inset-0 bg-black/50 flex items-center justify-center">
                      <div className="text-white text-center">
                        <RotateCw className="h-8 w-8 animate-spin mx-auto mb-2" />
                        <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>
                      </div>
                    </div>
                  )}
                </div>

                <div className="flex gap-2 justify-center">
                  <Button
                    onClick={sendToChat}
                    disabled={isProcessingImage || isScanning}
                    size="lg"
                    className="flex items-center gap-2"
                  >
                    {isScanning ? (
                      <>
                        <RotateCw className="h-5 w-5 animate-spin" />
                        –û—Ç–ø—Ä–∞–≤–∫–∞...
                      </>
                    ) : (
                      <>
                        <CheckCircle2 className="h-5 w-5" />
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç
                      </>
                    )}
                  </Button>
                  <Button
                    onClick={() => setCapturedImage(null)}
                    variant="outline"
                    size="lg"
                    disabled={isProcessingImage}
                  >
                    –ü–µ—Ä–µ—Å–Ω—è—Ç—å
                  </Button>
                  <Button
                    onClick={closeCamera}
                    variant="outline"
                    size="lg"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </Button>
                </div>
              </div>
            )}
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —à–∞–±–ª–æ–Ω–∞ */}
      <Dialog open={showTemplatePreview} onOpenChange={setShowTemplatePreview}>
        <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>{selectedTemplateForPreview?.name}</DialogTitle>
            <DialogDescription>{selectedTemplateForPreview?.description}</DialogDescription>
          </DialogHeader>

          {selectedTemplateForPreview?.template && (
            <div className="space-y-4">
              <div className="bg-muted p-4 rounded-lg">
                <h4 className="font-semibold mb-2">–®–∞–±–ª–æ–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞:</h4>
                <pre className="text-sm whitespace-pre-wrap font-mono bg-background p-3 rounded border overflow-x-auto">
                  {selectedTemplateForPreview.template}
                </pre>
              </div>

              <div className="flex gap-2">
                <Button
                  onClick={() => handleTemplateClick(selectedTemplateForPreview.name)}
                  className="flex-1"
                >
                  –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
                </Button>
                <Button
                  variant="outline"
                  onClick={() => setShowTemplatePreview(false)}
                >
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ */}
      {showInteractiveChat && (
        <>
          {console.log('üé® Rendering interactive chat modal')}
          <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4" onClick={() => setShowInteractiveChat(false)}>
            <div className="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
              <div className="p-6 border-b flex justify-between items-start">
                <div className="flex-1">
                  <h2 className="text-lg font-semibold flex items-center gap-2">
                    <MessageSquare className="h-5 w-5" />
                    –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ: {selectedTemplateForChat?.name}
                  </h2>
                  <p className="text-sm text-gray-600 mt-1">
                    –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ì–∞–ª–∏–Ω—ã, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
                  </p>
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => setShowInteractiveChat(false)}
                  className="h-8 w-8 p-0"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>

          <div className="flex-1 flex flex-col min-h-0">
            {/* –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */}
            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-muted/30 rounded-lg mb-4">
              {chatMessages.map((message, index) => (
                <div
                  key={index}
                  className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
                >
                  <div
                    className={`max-w-[80%] p-3 rounded-lg ${
                      message.role === 'user'
                        ? 'bg-primary text-primary-foreground'
                        : 'bg-background border'
                    }`}
                  >
                    <p className="text-sm whitespace-pre-wrap">{message.content}</p>
                  </div>
                </div>
              ))}

              {isWaitingForAI && (
                <div className="flex justify-start">
                  <div className="bg-background border p-3 rounded-lg">
                    <div className="flex items-center gap-2">
                      <RefreshCw className="h-4 w-4 animate-spin" />
                      <span className="text-sm text-muted-foreground">–ì–∞–ª–∏–Ω–∞ –ø–µ—á–∞—Ç–∞–µ—Ç...</span>
                    </div>
                  </div>
                </div>
              )}

              <div ref={chatEndRef} />
            </div>

            {/* –ì–æ—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç */}
            {completedDocument && (
              <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="font-semibold text-green-900 flex items-center gap-2">
                    <CheckCircle2 className="h-5 w-5" />
                    –î–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤!
                  </h4>
                  <Button
                    onClick={downloadDocument}
                    size="sm"
                    className="flex items-center gap-2"
                  >
                    <Download className="h-4 w-4" />
                    –°–∫–∞—á–∞—Ç—å
                  </Button>
                </div>
                <div className="bg-white p-3 rounded border max-h-40 overflow-y-auto">
                  <pre className="text-xs whitespace-pre-wrap font-mono">{completedDocument}</pre>
                </div>
              </div>
            )}

            {/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –≥–æ—Ç–æ–≤) */}
            {!completedDocument && (
              <div className="flex gap-2">
                <textarea
                  value={currentUserInput}
                  onChange={(e) => setCurrentUserInput(e.target.value)}
                  onKeyPress={handleKeyPress}
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."
                  className="flex-1 min-h-[60px] max-h-[120px] resize-none rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                  disabled={isWaitingForAI}
                />
                <Button
                  onClick={handleSendMessage}
                  disabled={!currentUserInput.trim() || isWaitingForAI}
                  className="self-end"
                >
                  –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </Button>
              </div>
            )}
          </div>

              {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
              <div className="flex justify-between pt-4 border-t">
                <Button variant="outline" onClick={resetChat}>
                  –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
                </Button>
                <Button onClick={() => setShowInteractiveChat(false)}>
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
              </div>
            </div>
          </div>
        </>
      )}
    </div>
  );
};

export default DocumentFilling;
