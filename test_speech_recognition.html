<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Speech Recognition</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.recording {
            background-color: #ffebee;
            border: 1px solid #f44336;
        }
        .status.ready {
            background-color: #e8f5e8;
            border: 1px solid #4caf50;
        }
        .status.inactive {
            background-color: #f5f5f5;
            border: 1px solid #9e9e9e;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .start { background-color: #4caf50; color: white; }
        .stop { background-color: #f44336; color: white; }
        .clear { background-color: #9e9e9e; color: white; }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
        }
        .error {
            background-color: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç Speech Recognition API</h1>
    <div style="background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; margin: 10px 0; border-radius: 5px;">
        <strong>‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong> Web Speech API —Ç—Ä–µ–±—É–µ—Ç HTTPS. –ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫–∏, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ HTTPS –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localhost.
        <br><br>
        <strong>–î–ª—è Chrome:</strong> –í –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –≤–≤–µ–¥–∏—Ç–µ <code>chrome://flags/#unsafely-treat-insecure-origin-as-secure</code> –∏ –¥–æ–±–∞–≤—å—Ç–µ <code>http://localhost:3002</code>
        <br>
        <strong>–î–ª—è Firefox:</strong> –í <code>about:config</code> —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ <code>media.webspeech.recognition.force_allow_insecure</code> –≤ <code>true</code>
    </div>

    <div id="status" class="status inactive">–°—Ç–∞—Ç—É—Å: –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</div>

    <div>
        <button id="startBtn" class="start">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
        <button id="stopBtn" class="stop" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button id="clearBtn" class="clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <h3>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</h3>
    <textarea id="transcript" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç..."></textarea>

    <h3>–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
    <div id="interim" style="padding: 10px; background-color: #f9f9f9; border-radius: 5px; min-height: 30px;"></div>

    <h3>–õ–æ–≥:</h3>
    <div id="log" style="padding: 10px; background-color: #f5f5f5; border-radius: 5px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>

    <script>
        let recognition = null;
        let isRecording = false;
        let isContinuous = false;

        const statusDiv = document.getElementById('status');
        const transcriptTextarea = document.getElementById('transcript');
        const interimDiv = document.getElementById('interim');
        const logDiv = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            if (type === 'error') {
                logEntry.style.color = 'red';
            }
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'inactive') {
            statusDiv.textContent = `–°—Ç–∞—Ç—É—Å: ${message}`;
            statusDiv.className = `status ${type}`;
        }

        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                log('Web Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'error');
                alert('Web Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                return false;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'ru-RU';
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                log('üé§ Speech recognition started');
                isRecording = true;
                updateStatus('–ó–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–∞', 'recording');
                startBtn.disabled = true;
                stopBtn.disabled = false;
            };

            recognition.onresult = (event) => {
                log('üìù Speech recognition result received');

                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    log(`‚úÖ Final transcript: "${finalTranscript}"`);
                    transcriptTextarea.value += (transcriptTextarea.value ? ' ' : '') + finalTranscript.trim();

                    if (isContinuous) {
                        log('üîÑ Continuous mode: restarting recognition in 1 second...');
                        setTimeout(() => {
                            if (isContinuous && recognition) {
                                try {
                                    recognition.start();
                                } catch (error) {
                                    log(`‚ùå Failed to restart recognition: ${error}`, 'error');
                                    isContinuous = false;
                                    updateStatus('–û—à–∏–±–∫–∞', 'error');
                                }
                            }
                        }, 1000);
                    }
                }

                interimDiv.textContent = interimTranscript || '–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ—á–∏...';
            };

            recognition.onerror = (event) => {
                log(`‚ùå Speech recognition error: ${event.error}`, 'error');
                console.error('Speech recognition error details:', event);

                isRecording = false;
                updateStatus(`–û—à–∏–±–∫–∞: ${event.error}`, 'error');
                startBtn.disabled = false;
                stopBtn.disabled = true;

                // Handle specific errors
                switch (event.error) {
                    case 'not-allowed':
                        alert('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
                        break;
                    case 'no-speech':
                        if (isContinuous) {
                            log('ü§´ No speech detected, restarting...');
                            setTimeout(() => startRecognition(), 1000);
                        }
                        break;
                    case 'network':
                        alert('–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
                        break;
                }
            };

            recognition.onend = () => {
                log('üõë Speech recognition ended');
                isRecording = false;
                updateStatus('–ù–µ–∞–∫—Ç–∏–≤–µ–Ω', 'inactive');
                startBtn.disabled = false;
                stopBtn.disabled = true;
            };

            log('‚úÖ Speech recognition initialized successfully');
            return true;
        }

        async function startRecognition() {
            if (!recognition) {
                if (!initSpeechRecognition()) return;
            }

            try {
                // Check microphone permissions
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    log('üéôÔ∏è Requesting microphone permission...');
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    log('‚úÖ Microphone permission granted');
                }

                setTimeout(() => {
                    if (recognition && !isRecording) {
                        recognition.start();
                    }
                }, 100);

            } catch (error) {
                log(`‚ùå Microphone permission denied: ${error}`, 'error');
                alert('–î–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
            }
        }

        function stopRecognition() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            isContinuous = false;
        }

        // Event listeners
        startBtn.addEventListener('click', () => {
            isContinuous = confirm('–í–∫–ª—é—á–∏—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–µ–∂–∏–º (–±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è)?');
            startRecognition();
        });

        stopBtn.addEventListener('click', stopRecognition);

        document.getElementById('clearBtn').addEventListener('click', () => {
            transcriptTextarea.value = '';
            interimDiv.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ—á–∏...';
            log('üßπ Transcript cleared');
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Page loaded, initializing speech recognition...');
            initSpeechRecognition();
        });
    </script>
</body>
</html>
